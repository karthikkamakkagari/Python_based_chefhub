{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ title }} - Chef Hub</title>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #fceabb, #f8b500);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
    margin:0;
}

.container {
    width: 1100px;
    padding: 40px;
    background: #ffffffee;
    border-radius: 20px;
    box-shadow: 0 12px 35px rgba(0,0,0,0.25);
}

h2 {
    text-align:center;
    color:#e74c3c;
    margin-bottom: 20px;
    font-size:2.2em;
}

form { display: flex; flex-direction: column; gap: 20px; }

.form-field { display:flex; flex-direction: column; }

label {
    font-weight: 600;
    margin-bottom:6px;
    color:#2c3e50;
}

input, select, textarea {
    padding: 10px;
    font-size:1em;
    border:1px solid #ccc;
    border-radius:8px;
    width:100%;
    box-sizing:border-box;
}

textarea { min-height:80px; resize:vertical; }

.scroll-box {
    max-height:300px;
    overflow-y:auto;
    border:1px solid #ddd;
    border-radius:8px;
    padding:10px;
    background:#fafafa;
}

.ingredient-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
}

.ingredient-row select {
    flex: 2;
}

.ingredient-row input[name$='-quantity'] {
    flex: 1;
    max-width: 100px;
}

.ingredient-row input[name$='-unit'] {
    flex: 1;
    max-width: 100px;
}

.ingredient-row input[name$='-price'] {
    flex: 1;
    max-width: 120px;
}

.ingredient-row button {
    background:#e74c3c;
    color:#fff;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
}

.ingredient-row input[type="checkbox"] {
    display:none;
}

.ingredient-total {
    flex: 1;
    max-width: 120px;
    background: #f0f0f0;
    font-weight: bold;
}


#add-ingredient {
    display:block;
    width:220px;
    margin:20px auto;
    padding:10px;
    background:#2ecc71;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}

#add-ingredient:hover { background:#27ae60; }

.form-actions {
    margin-top:30px;
    display:flex;
    justify-content:center;
    gap:15px;
}

.form-actions button {
    background:#1565c0;
    color:#fff;
    border:none;
    padding:12px 25px;
    border-radius:8px;
    font-weight:bold;
    cursor:pointer;
}

.form-actions button:hover { background:#0d47a1; }

.form-actions a {
    background:#e0e0e0;
    color:#2c3e50;
    text-decoration:none;
    padding:12px 25px;
    border-radius:8px;
    font-weight:bold;
}

.image-preview {
    margin-top:10px;
}

.image-preview img {
    width:200px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
}

.errorlist {
    color:#fff;
    background:#e74c3c;
    border-radius:6px;
    padding:6px;
    margin:6px 0;
    list-style:none;
}
</style>
</head>

<body>
<div class="container">

<h2>{{ title }}</h2>

<form method="post" enctype="multipart/form-data">
{% csrf_token %}

<!-- ðŸ”¹ Dish Basic Fields -->
{% for field in form %}
<div class="form-field">
    {{ field.label_tag }}
    {{ field }}

    {% if field.name == "image" and form.instance.image %}
        <div class="image-preview">
            <p><strong>Current Image:</strong></p>
            <img src="{{ form.instance.image.url }}">
        </div>
    {% endif %}

    {% if field.errors %}
        <ul class="errorlist">
            {% for error in field.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
</div>
{% endfor %}

<!-- ðŸ”¹ Ingredient Section -->
<h3>Ingredients</h3>

{{ formset.management_form }}

<div id="ingredients" class="scroll-box">
{% for form in formset %}
<div class="ingredient-row">
    {{ form.id }}

    <select name="{{ form.prefix }}-ingredient" id="id_{{ form.prefix }}-ingredient">
        <option value="">-- Select Ingredient --</option>
        {% for ing in ingredient_list %}
            <option value="{{ ing.id }}"
                data-price="{{ ing.price }}"
                {% if form.instance.ingredient and ing.id == form.instance.ingredient.id %}selected{% endif %}>
                {{ ing.name_en }}
                
            </option>
        {% endfor %}
    </select>
    {{ form.quantity }}
    {{ form.unit }}
    {{ form.price }}

    <input type="text" class="ingredient-total" readonly placeholder="Total">

    {{ form.DELETE }}
    <button type="button" class="remove-ingredient">Delete</button>

</div>
{% endfor %}
</div>
<div style="text-align:right; margin-top:15px; font-size:18px;">
    <strong>Total Cost: â‚¹ <span id="dish-total">0.00</span></strong>
</div>
<button type="button" id="add-ingredient">+ Add Ingredient</button>

<div class="form-actions">
    <button type="submit">ðŸ’¾ Save Dish</button>
    <a href="{% url 'dish_list' %}">Back to Dish List</a>
</div>

</form>
</div>

<!-- ðŸ”¹ JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const ingredientsContainer = document.getElementById("ingredients");
    const totalForms = document.getElementById("id_{{ formset.prefix }}-TOTAL_FORMS");

    // ðŸ”¥ Calculate total cost
    function calculateTotal() {
        let grandTotal = 0;

        document.querySelectorAll(".ingredient-row").forEach(row => {

            if (row.style.display === "none") return;

            const qty = parseFloat(row.querySelector("input[name$='-quantity']").value) || 0;
            const price = parseFloat(row.querySelector("input[name$='-price']").value) || 0;

            const rowTotal = qty * price;

            const totalField = row.querySelector(".ingredient-total");
            if (totalField) {
                totalField.value = rowTotal.toFixed(2);
            }

            grandTotal += rowTotal;
        });

        document.getElementById("dish-total").innerText = grandTotal.toFixed(2);
    }


    // ðŸ”¥ Auto fill price when ingredient selected
    function attachIngredientListener(row) {
        const select = row.querySelector("select");
        const priceInput = row.querySelector("input[name$='-price']");

        select.addEventListener("change", function() {
            const selectedOption = select.options[select.selectedIndex];
            const defaultPrice = selectedOption.getAttribute("data-price");
            if (defaultPrice) {
                priceInput.value = defaultPrice;
            }
            calculateTotal();
        });

        row.querySelector("input[name$='-quantity']").addEventListener("input", calculateTotal);
        priceInput.addEventListener("input", calculateTotal);
    }

    function updateDeleteButton(row) {
        row.querySelector(".remove-ingredient").addEventListener("click", function() {
            const delCheckbox = row.querySelector("input[type='checkbox']");
            if(delCheckbox) delCheckbox.checked = true;
            row.style.display = "none";
            calculateTotal();
        });
    }

    // Attach to existing rows
    ingredientsContainer.querySelectorAll(".ingredient-row").forEach(row=>{
        updateDeleteButton(row);
        attachIngredientListener(row);
    });

    document.getElementById("add-ingredient").addEventListener("click", function(){
        const newIndex = parseInt(totalForms.value);

        const row = document.createElement("div");
        row.className = "ingredient-row";

        row.innerHTML = `
            <select name="{{ formset.prefix }}-${newIndex}-ingredient">
                <option value="">-- Select Ingredient --</option>
                {% for ing in ingredient_list %}
                    <option value="{{ ing.id }}" data-price="{{ ing.price }}">{{ ing.name_en }}</option>
                {% endfor %}
            </select>

            <input type="number" name="{{ formset.prefix }}-${newIndex}-quantity" step="any" value="1">
            <input type="text" name="{{ formset.prefix }}-${newIndex}-unit" value="">
            <input type="number" name="{{ formset.prefix }}-${newIndex}-price" step="any" value="0">
            <input type="text" class="ingredient-total" readonly placeholder="Total">
            <input type="checkbox" name="{{ formset.prefix }}-${newIndex}-DELETE" style="display:none;">
            <button type="button" class="remove-ingredient">Delete</button>

        `;

        ingredientsContainer.appendChild(row);
        totalForms.value = newIndex + 1;

        updateDeleteButton(row);
        attachIngredientListener(row);
    });
    // document.addEventListener("change", function(e) {

    //     if (e.target.classList.contains("ingredient-select")) {

    //         let ingredientId = e.target.value;
    //         let row = e.target.closest(".ingredient-row");

    //         fetch(`/dishes/get-ingredient/?ingredient_id=${ingredientId}`)
    //             .then(response => response.json())
    //             .then(data => {
    //                 if (!data.error) {
    //                     row.querySelector("input[name$='-quantity']").value = data.quantity;
    //                     row.querySelector("select[name$='-unit']").value = data.unit;
    //                     row.querySelector("input[name$='-price']").value = data.price;
    //                 }
    //             });
    //     }
    // });
    
    calculateTotal();
});
</script>

</body>
</html>
