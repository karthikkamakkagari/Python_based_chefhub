{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ title }} - Chef Hub</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #fceabb, #f8b500);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
    margin:0;
}
.container {
    width: 1100px;
    padding: 40px;
    background: #ffffffee;
    border-radius: 20px;
    box-shadow: 0 12px 35px rgba(0,0,0,0.25);
}
h2 { text-align:center; color:#e74c3c; margin-bottom: 20px; font-size:2.2em; }
form { display: flex; flex-direction: column; gap: 20px; }
.form-field { display:flex; flex-direction: column; }
label { font-weight: 600; margin-bottom:6px; color:#2c3e50; }
input, select, textarea { padding: 10px; font-size:1em; border:1px solid #ccc; border-radius:8px; width:100%; box-sizing:border-box; }
textarea { min-height:80px; resize:vertical; }
input[readonly] { background-color: #e9ecef; cursor:not-allowed; opacity:0.7; }
.scroll-box { max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa; }
.ingredient-row { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
.ingredient-row select, .ingredient-row input { flex:1; padding:8px; border-radius:6px; }
.ingredient-row input[name$='-unit'] { max-width: 100px; }
.ingredient-row input[name$='-quantity'], .ingredient-row input[name$='-price'] { max-width:120px; }
.ingredient-row button { padding:6px 12px; background:#e74c3c; color:#fff; border:none; border-radius:6px; cursor:pointer; }
.ingredient-row button:hover { background:#c0392b; }
#add-ingredient { display:block; width:200px; margin:20px auto; padding:10px; background:#2ecc71; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
#add-ingredient:hover { background:#27ae60; }
.form-actions { margin-top:30px; display:flex; justify-content:center; gap:15px; }
.form-actions button { background:#1565c0; color:#fff; border:none; padding:12px 25px; border-radius:8px; font-weight:bold; cursor:pointer; }
.form-actions button:hover { background:#0d47a1; }
.form-actions a { background:#e0e0e0; color:#2c3e50; text-decoration:none; padding:12px 25px; border-radius:8px; font-weight:bold; }
.form-actions a:hover { background:#d0d0d0; }
.errorlist { color:#fff; background:#e74c3c; border-radius:6px; padding:6px; margin:6px 0; list-style:none; }
</style>
</head>
<body>
<div class="container">
<h2>{{ title }}</h2>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% for field in form %}
        <div class="form-field">
            {{ field.label_tag }} {{ field }}
            {% if field.errors %}
            <ul class="errorlist">
                {% for error in field.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    {% endfor %}

    <h3>Ingredients</h3>
    {{ formset.management_form }}
    <div id="ingredients" class="scroll-box">
        {% for form in formset %}
        <div class="ingredient-row">
            <select name="{{ form.prefix }}-ingredient">
                <option value="">-- Select Ingredient --</option>
                {% for ing in ingredient_list %}
                    <option value="{{ ing.id }}" data-unit="{{ ing.unit }}" data-price="{{ ing.price }}"
                        {% if form.instance.ingredient and ing.id == form.instance.ingredient.id %}selected{% endif %}>
                        {{ ing.name_en }}
                    </option>
                {% endfor %}
            </select>
            <input type="number" name="{{ form.prefix }}-quantity" step="any" value="{{ form.instance.quantity|default:1 }}">
            <input type="text" name="{{ form.prefix }}-unit" value="{{ form.instance.unit|default:'' }}">
            <input type="number" name="{{ form.prefix }}-price" step="any" value="{{ form.instance.price|default:0 }}">
            {{ form.DELETE }}
            <button type="button" class="remove-ingredient">Delete</button>
        </div>
        {% endfor %}
    </div>

    <button type="button" id="add-ingredient">+ Add Ingredient</button>

    <div class="form-actions">
        <button type="submit">Save Dish</button>
        <a href="{% url 'dish_list' %}">Back to Dish List</a>
    </div>
</form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const ingredientsContainer = document.getElementById("ingredients");
    const totalForms = document.getElementById("id_{{ formset.prefix }}-TOTAL_FORMS");

    function updateDeleteButton(row) {
        const btn = row.querySelector(".remove-ingredient");
        btn.addEventListener("click", function() {
            const delCheckbox = row.querySelector("input[type='checkbox']");
            if(delCheckbox) delCheckbox.checked = true;
            row.style.display = "none";
        });
    }

    function bindSelect(row) {
        const select = row.querySelector("select");
        const unitInput = row.querySelector("input[name$='-unit']");
        const priceInput = row.querySelector("input[name$='-price']");
        const qtyInput = row.querySelector("input[name$='-quantity']");
        select.addEventListener("change", function() {
            const option = select.options[select.selectedIndex];
            unitInput.value = option.dataset.unit || "";
            priceInput.value = option.dataset.price || 0;
            if(!qtyInput.value) qtyInput.value = 1;
        });
    }

    ingredientsContainer.querySelectorAll(".ingredient-row").forEach(row=>{
        updateDeleteButton(row);
        bindSelect(row);
    });

    document.getElementById("add-ingredient").addEventListener("click", function(){
        const newIndex = parseInt(totalForms.value);
        const row = document.createElement("div");
        row.className = "ingredient-row";
        row.innerHTML = `
            <select name="{{ formset.prefix }}-${newIndex}-ingredient">
                <option value="">-- Select Ingredient --</option>
                {% for ing in ingredient_list %}
                    <option value="{{ ing.id }}" data-unit="{{ ing.unit }}" data-price="{{ ing.price }}">{{ ing.name_en }}</option>
                {% endfor %}
            </select>
            <input type="number" name="{{ formset.prefix }}-${newIndex}-quantity" step="any" value="1">
            <input type="text" name="{{ formset.prefix }}-${newIndex}-unit" value="">
            <input type="number" name="{{ formset.prefix }}-${newIndex}-price" step="any" value="0">
            <input type="checkbox" name="{{ formset.prefix }}-${newIndex}-DELETE" style="display:none;">
            <button type="button" class="remove-ingredient">Delete</button>
        `;
        ingredientsContainer.appendChild(row);
        totalForms.value = newIndex + 1;
        updateDeleteButton(row);
        bindSelect(row);
    });
});
</script>
</body>
</html>
